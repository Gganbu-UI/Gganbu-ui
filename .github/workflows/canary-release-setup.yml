# .github/workflows/canary-release-setup.yml
name: âœ¨ Canary release setup

on:
  push:
    branches:
      - feature/**

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    name: Create pull request
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for existing pull request
        id: check_pr
        run: |
          PR_EXISTS=$(gh pr list --head "${GITHUB_REF#refs/heads/}" --state open --json number --jq '.[0].number')
          if [ -n "$PR_EXISTS" ]; then
            echo "Pull request already exists for this branch. Skipping creation."
            echo "::set-output name=PR_EXISTS::$PR_EXISTS"
            exit 0
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create pull request by gh pr create
        if: steps.check_pr.outputs.PR_EXISTS == ''
        run: |
          PULL_REQUEST_TITLE="$(git log -1 --pretty=%B)"
          gh pr create --base develop -H "${GITHUB_REF#refs/heads/}" --title "${PULL_REQUEST_TITLE}" --fill --body-file .github/PULL_REQUEST_TEMPLATE.md -d
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-changesets:
    runs-on: ubuntu-latest
    name: Check for changes in .changesets
    outputs:
      any_changed: ${{ steps.check_changesets.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check .changesets directory for changes
        id: check_changesets
        uses: tj-actions/changed-files@v44
        with:
          files: |
            .changeset/**

  changesets-release:
    name: Release packages with changesets
    runs-on: ubuntu-latest
    needs: [check-changesets]
    if: ${{ needs.check-changesets.outputs.any_changed == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Setup Git User
        shell: bash
        # This sets the git user to the author of the last commit
        run: |
          git config --global user.name "$(git --no-pager log --format=format:'%an' -n 1)"
          git config --global user.email "$(git --no-pager log --format=format:'%ae' -n 1)"

      - name: Install dependencies
        run: yarn install --immutable --immutable-cache --check-cache
      - name: Creating .npmrc
        run: |
          cat << EOF > "$HOME/.npmrc"
            //registry.npmjs.org/:_authToken=$NPM_TOKEN
          EOF
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Create Release Pull Request or Publish to NPM
        id: changesets
        uses: changesets/action@v1
        with:
          # this expects you to have a npm script called version that runs some logic and then calls `changeset version`.
          version: yarn run version:canary
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          publish: yarn run release:canary
          title: 'ci(changesets): :package: version packages'
          commit: 'ci(changesets): version packages'
          setupGitUser: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  check-chromatic:
    runs-on: ubuntu-latest
    name: Check for changes in apps/storybook
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/storybook/**

  chromatic:
    name: Run visual tests
    needs: [check-chromatic]
    if: ${{ needs.check-chromatic.outputs.any_changed == 'true' }}
    uses: ./.github/workflows/chromatic.yml
    secrets: inherit
